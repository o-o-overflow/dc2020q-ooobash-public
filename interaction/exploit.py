#!/usr/bin/env python2

from os.path import *
from pwn import *
import sys
import random
import hashlib

context.log_level = 'info'

with_stderr = True

def main():

    host = sys.argv[1]
    port = int(sys.argv[2])

    io = remote(host, port)

    if with_stderr:
        result = io.recvuntil('bash-5.0$ ')

    res = exec_cmd(io, 'pwd')

    tmp_dir = '/tmp/' + get_rand_str(n=12)
    
    exec_cmd(io, 'mkdir %s' % tmp_dir)

    # paths are relative to this script
    copy_file(io, 'scripts/stage1', join(tmp_dir, 'stage1'))
    copy_file(io, 'scripts/stage2', join(tmp_dir, 'stage2'))
    copy_file(io, 'scripts/stage3', join(tmp_dir, 'stage3'))

    res = exec_cmd(io, 'cd %s; /bin/bash stage1' % tmp_dir, untilprompt=False)

    res = io.recvuntil('getflag')
    res = io.recvuntil('certified bash reverser')
    res = io.recvuntil('\n')
     
    assert res.find('The flag is OOO') >= 0
    flag = res.split('The flag is ')[1].strip()

    exec_cmd(io, 'rm -rf %s' % tmp_dir)

    print 'FLAG: %s' % flag

    sys.exit(0)


def exec_cmd(io, cmd, untilprompt=True):
    io.sendline(cmd)
    if untilprompt:
        if with_stderr:
            # it's somehow repeated twice in the output, but only the first time...
            res = io.recvuntil('bash-5.0$ ')
        else:
            # TODO HACK
            res = io.recv(4096)
        # remove first line (the repeated command) and the last one (bash prompt)
        res = '\n'.join(res.split('\n')[1:-1])
        return res
    else:
        return None


def copy_file(io, src_fp, dst_fp):

    src_fp = abspath(join(dirname(__file__), src_fp))

    with open(src_fp, 'rb') as f:
        src = f.read()

    buf = ''
    buf += '(cat <<\'EOF\'\n'
    buf += src + '\n'
    buf += 'EOF\n'
    buf += (') > %s' % dst_fp)

    io.sendline(buf)
    io.recvuntil('bash-5.0$ ')


def get_rand_str(n=8):
    out = ''.join(map(chr, [ random.randrange(ord('a'), ord('z')+1) for _ in range(n) ]))
    return out


if __name__ == '__main__':
    main()
